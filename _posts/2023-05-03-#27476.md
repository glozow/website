---
layout: pr
date: 2023-05-03
title: "Keep CPFP'd transactions when loading from mempool.dat"
pr: 27476
authors: [glozow]
components: ["mempool"]
host: glozow
status: upcoming
commit:
---

## Notes

- When loading mempool.dat, we apply `-minrelaytxfee` and mempool min feerate on each transaction,
  meaning we may reject transactions that are CPFP'd by later transactions mempool.dat. Today, we
can run into this problem if we are shrinking `-maxmempool` or raising `-minrelaytxfee` on a
restart.

- `CTxMemPool::TrimToSize()` is called each time a transaction is submitted to the mempool after
  having passed validation checks. It checks to see if the mempool has exceeded its maximum memory
capacity and, if so, evicts descendant packages in ascending descendant feerate order.

- [PR #27476](https://github.com/bitcoin/bitcoin/pull/27476)'s approach to this problem is to avoid
  calling `TrimToSize()` when submitting the transactions (by calling `AcceptToMemoryPool` with `bypass_limits=True`) until all the transactions have been loaded.

- Other alternative approaches have been
  [considered](https://github.com/bitcoin/bitcoin/pull/27476#issuecomment-1516503220), each with
advantages and disadvantages.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

1. What problem is this PR trying to address? Does this problem exist today, or only if the
   mempool.dat contains transactions bumped by package CPFP?

1. What is this PR's approach to solving this problem?

1. What are the limitations to this approach?

1. What alternative approaches might work? Before reading the discussion, did you come up with any alternative approaches?

1. What are some advantages and disadvantages to each alternative approach?

1. Locks `cs_main` and `mempool.cs` must be held while submitting transactions for submission to the
   mempool. While the node is loading mempool.dat, what other threads might be submitting
transactions for validation?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
